name: Génération de Carte à Gratter

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: "URL de l'image de fond"
        required: true
      text:
        description: "Texte pour la carte"
        required: true
      color:
        description: "Couleur du texte"
        required: true

jobs:
  create_card:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout du générateur
      uses: actions/checkout@v2

    - name: Afficher les paramètres de création de carte
      run: |
        echo "Image URL : ${{ github.event.inputs.image_url }}"
        echo "Texte : ${{ github.event.inputs.text }}"
        echo "Couleur : ${{ github.event.inputs.color }}"

    - name: Configurer l'utilisateur Git
      run: |
        git config --global user.email "etienneleborgne@gmail.com"
        git config --global user.name "lumios-le-jeu"

    - name: Clonage du dépôt modèle
      run: |
        REPO_NAME="card-$(date +%s)"
        echo "Nom du dépôt : $REPO_NAME"
        git clone https://github.com/lumios-le-jeu/carte-a-gratter-template.git "$REPO_NAME"
        cd "$REPO_NAME"

    - name: Changer de remote et configurer le push
      run: |
        git remote rm origin
        git remote add origin "https://${GH_TOKEN}@github.com/lumios-le-jeu/${REPO_NAME}.git"
        echo "Push vers le nouveau dépôt"
        git push -u origin main
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Personnaliser la carte avec les entrées
      run: |
        cd "$REPO_NAME"
        sed -i "s|PLACEHOLDER_IMAGE_URL|${{ github.event.inputs.image_url }}|g" index.html
        sed -i "s|PLACEHOLDER_TEXT|${{ github.event.inputs.text }}|g" index.html
        sed -i "s|PLACEHOLDER_COLOR|${{ github.event.inputs.color }}|g" index.html
        git add .
        git commit -m "Personnalisation de la carte avec le texte et l'image de fond"
        git push

    - name: Activer GitHub Pages
      run: |
        gh api -X POST "repos/lumios-le-jeu/${REPO_NAME}/pages/builds" -f "build_type=workflow"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
